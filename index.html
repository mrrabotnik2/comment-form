<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Story Comments</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; padding:20px; }
.container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
input, textarea, button { width:100%; padding:12px; margin-top:8px; font-size:15px; }
button { background:#4CAF50; color:white; border:none; cursor:pointer; }
button:hover { background:#45a049; }
.error { color:red; }
.success { color:green; }
.comment { border-bottom:1px solid #ddd; padding:10px 0; }
.author { font-weight:bold; }
.timestamp { font-size:12px; color:#666; }
#comment-form { display:none; margin-top:15px; }
</style>
</head>
<body>

<div class="container">
<h2>Comments</h2>

<!-- AUTH FORM -->
<div id="auth-form">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password (min 6 chars)">
  <input id="nickname" placeholder="Choose a nickname (new users only)">
  <button id="signup-btn">Sign Up</button>
  <button id="login-btn">Log In</button>
  <p id="auth-error" class="error"></p>
  <p id="auth-success" class="success"></p>
</div>

<!-- COMMENT FORM -->
<div id="comment-form">
  <textarea id="comment" rows="4" placeholder="Write your comment..."></textarea>
  <button id="submit-comment-btn">Post Comment</button>
</div>

<div id="comment-list"></div>
</div>

<script>
// =================== IMMEDIATE EXECUTION PREVENTION ===================
// If this script has already run, STOP immediately
if (window.commentsAppLoaded) {
    console.warn('Comments app already loaded, stopping duplicate execution');
    // If we're here, the page is loading this script twice
    // Let's clean up and exit
    throw new Error('Script already executed');
}

// Mark as loaded IMMEDIATELY
window.commentsAppLoaded = true;

// =================== SINGLE INITIALIZATION ===================
// Use var instead of const/let to avoid duplicate declaration errors
var supabase;
var storyCommentsApp = {};

// Only initialize if not already done
if (!window.supabaseClient) {
    const SUPABASE_URL = "https://pidzgdrdgqgsayfoxqba.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpZHpnZHJkZ3Fnc2F5Zm94cWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDI1OTcsImV4cCI6MjA4MTIxODU5N30.6sNn3jbNVfl-MEowIEjUknEKHlOcfKvVRa5pFqCHiw0";

    try {
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized");
    } catch (error) {
        console.error("Failed to initialize Supabase:", error);
        document.body.innerHTML = '<div class="container"><h2>System Error</h2><p class="error">Failed to load comments system. Please refresh.</p></div>';
        throw error;
    }
}

// Use the global instance
supabase = window.supabaseClient;

// =================== MAIN APPLICATION ===================
(function() {
    'use strict';
    
    // Store element references in our app object
    storyCommentsApp.elements = {
        storyId: new URLSearchParams(window.location.search).get("story") || "default",
        emailEl: document.getElementById("email"),
        passwordEl: document.getElementById("password"),
        nicknameEl: document.getElementById("nickname"),
        authForm: document.getElementById("auth-form"),
        commentForm: document.getElementById("comment-form"),
        commentInput: document.getElementById("comment"),
        commentList: document.getElementById("comment-list"),
        errorEl: document.getElementById("auth-error"),
        successEl: document.getElementById("auth-success")
    };
    
    const els = storyCommentsApp.elements;
    
    // =================== EVENT HANDLERS ===================
    storyCommentsApp.handleSignup = async function() {
        els.errorEl.textContent = "";
        els.successEl.textContent = "";
    
        if (!els.emailEl.value || !els.passwordEl.value || !els.nicknameEl.value) {
            els.errorEl.textContent = "Please fill all fields";
            return;
        }
    
        if (els.passwordEl.value.length < 6) {
            els.errorEl.textContent = "Password must be at least 6 characters";
            return;
        }
    
        try {
            const { data, error } = await supabase.auth.signUp({
                email: els.emailEl.value.trim(),
                password: els.passwordEl.value,
                options: {
                    data: { nickname: els.nicknameEl.value.trim() },
                    emailRedirectTo: window.location.origin
                }
            });
    
            if (error) {
                els.errorEl.textContent = error.message;
            } else {
                els.successEl.textContent = "Sign up successful! Check your email for confirmation.";
                els.passwordEl.value = "";
                
                if (data.user) {
                    // Store profile
                    try {
                        await supabase.from('profiles').upsert({
                            id: data.user.id,
                            nickname: els.nicknameEl.value.trim(),
                            created_at: new Date().toISOString()
                        });
                    } catch (profileErr) {
                        console.error("Profile error:", profileErr);
                    }
                }
            }
        } catch (err) {
            els.errorEl.textContent = "An error occurred. Please try again.";
            console.error(err);
        }
    };
    
    storyCommentsApp.handleLogin = async function() {
        els.errorEl.textContent = "";
        els.successEl.textContent = "";
    
        if (!els.emailEl.value || !els.passwordEl.value) {
            els.errorEl.textContent = "Please enter email and password";
            return;
        }
    
        try {
            const { error } = await supabase.auth.signInWithPassword({
                email: els.emailEl.value.trim(),
                password: els.passwordEl.value
            });
    
            if (error) {
                els.errorEl.textContent = error.message;
            } else {
                els.successEl.textContent = "Login successful!";
                els.passwordEl.value = "";
            }
        } catch (err) {
            els.errorEl.textContent = "An error occurred. Please try again.";
            console.error(err);
        }
    };
    
    storyCommentsApp.handleCommentSubmit = async function() {
        const content = els.commentInput.value.trim();
        if (!content) return alert("Please write a comment!");
    
        try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            
            if (userError) return alert("Error: " + userError.message);
            if (!user) return alert("You must log in to comment!");
            if (!user.email_confirmed_at) return alert("Confirm your email to post comments");
    
            const { error } = await supabase.from("story_comments").insert({
                story_id: els.storyId,
                user_id: user.id,
                content: content,
                created_at: new Date().toISOString()
            });
    
            if (error) {
                alert("Error: " + error.message);
            } else {
                els.commentInput.value = "";
                storyCommentsApp.loadComments();
            }
        } catch (err) {
            alert("An error occurred: " + err.message);
            console.error(err);
        }
    };
    
    storyCommentsApp.loadComments = async function() {
        try {
            const { data, error } = await supabase
                .from("story_comments")
                .select(`
                    content, 
                    created_at, 
                    profiles (nickname)
                `)
                .eq("story_id", els.storyId)
                .order("created_at", { ascending: false });
    
            if (error) throw error;
    
            if (!data || data.length === 0) {
                els.commentList.innerHTML = "<p>No comments yet. Be the first!</p>";
                return;
            }
    
            els.commentList.innerHTML = data.map(c => {
                const nickname = c.profiles?.nickname || "Anonymous";
                return `
                    <div class="comment">
                        <div class="author">${nickname}</div>
                        <div>${c.content}</div>
                        <div class="timestamp">${new Date(c.created_at).toLocaleString()}</div>
                    </div>
                `;
            }).join("");
        } catch (err) {
            console.error("Error loading comments:", err);
            els.commentList.innerHTML = `<p class="error">Error loading comments</p>`;
        }
    };
    
    // =================== AUTH STATE ===================
    if (!window.authListenerSet) {
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Auth event:", event);
            
            if (event === "SIGNED_IN" && session?.user) {
                if (session.user.email_confirmed_at) {
                    els.authForm.style.display = "none";
                    els.commentForm.style.display = "block";
                    els.successEl.textContent = `Welcome, ${session.user.user_metadata?.nickname || 'User'}!`;
                } else {
                    els.successEl.textContent = "Please confirm your email.";
                }
            } else if (event === "SIGNED_OUT") {
                els.authForm.style.display = "block";
                els.commentForm.style.display = "none";
                els.successEl.textContent = "";
            }
            
            storyCommentsApp.loadComments();
        });
        window.authListenerSet = true;
    }
    
    // =================== INITIALIZE ===================
    storyCommentsApp.init = function() {
        // Attach event listeners (only once)
        if (!els.signupBtnListener) {
            document.getElementById("signup-btn").addEventListener("click", storyCommentsApp.handleSignup);
            document.getElementById("login-btn").addEventListener("click", storyCommentsApp.handleLogin);
            document.getElementById("submit-comment-btn").addEventListener("click", storyCommentsApp.handleCommentSubmit);
            els.signupBtnListener = true;
        }
        
        // Check current auth state
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session?.user?.email_confirmed_at) {
                els.authForm.style.display = "none";
                els.commentForm.style.display = "block";
            }
        });
        
        // Load comments
        storyCommentsApp.loadComments();
        
        console.log("Story comments app initialized for:", els.storyId);
    };
    
    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', storyCommentsApp.init);
    } else {
        storyCommentsApp.init();
    }
    
    // Make app accessible globally (optional)
    window.storyCommentsApp = storyCommentsApp;
    
})();
</script>

</body>
</html>
