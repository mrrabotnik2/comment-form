<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Comments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; max-width: 600px; margin: auto; padding: 10px; }
input, textarea, button { width: 100%; margin-top: 6px; padding: 8px; }
textarea { min-height: 80px; }
button { cursor: pointer; }
.comment { border-bottom: 1px solid #ddd; padding: 8px 0; }
.meta { font-size: 0.8em; color: #666; }
#logout { margin-top: 10px; background: #eee; }
</style>
</head>
<body>

<h3>Comments</h3>

<div id="auth"></div>

<div id="commentsSection" style="display:none;">
  <textarea id="commentInput" placeholder="Write a comment..."></textarea>
  <button id="postComment">Post Comment</button>
  <button id="logout">Log out</button>
  <div id="commentList"></div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://pidzgdrdgqgsayfoxqba.supabase.co",
  "sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z"
);

const storyId = new URLSearchParams(window.location.search).get("story") || "test";

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function showAuth() {
  document.getElementById("auth").innerHTML = `
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <input id="nickname" type="text" placeholder="Nickname">
    <button id="signupBtn">Sign Up</button>
    <button id="loginBtn">Log In</button>
  `;
  document.getElementById("signupBtn").addEventListener("click", signup);
  document.getElementById("loginBtn").addEventListener("click", login);
}

function showComments() {
  document.getElementById("auth").style.display = "none";
  document.getElementById("commentsSection").style.display = "block";
}

async function checkUser() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (user) showComments();
  else showAuth();
}

async function signup() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const nickname = document.getElementById("nickname").value.trim();
  if (!email || !password || !nickname) { alert("Fill all fields"); return; }

  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if (error) { alert(error.message); return; }

  alert("Check your email to confirm your account before logging in.");
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const nickname = document.getElementById("nickname").value.trim();

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { alert(error.message); return; }

  const user = data.user;
  if (!user) { alert("Email not confirmed yet."); return; }

  // Upsert nickname
  if (nickname) {
    const { error: nickError } = await supabaseClient.from("users").upsert({ id: user.id, nickname });
    if (nickError) alert("Error saving nickname: " + nickError.message);
  }

  showComments();
  loadComments();
}

document.getElementById("logout")?.addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  location.reload();
});

document.getElementById("postComment")?.addEventListener("click", postComment);

async function postComment() {
  const comment = document.getElementById("commentInput").value.trim();
  if (!comment) return;

  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) { alert("Please log in first."); return; }

  const { error } = await supabaseClient.from("story_comments").insert({
    story_id: storyId, content: comment, user_id: user.id
  });
  if (error) alert(error.message);
  else { document.getElementById("commentInput").value = ""; loadComments(); }
}

async function loadComments() {
  const { data, error } = await supabaseClient
    .from("story_comments")
    .select("content, created_at, users(nickname)")
    .eq("story_id", storyId)
    .order("created_at", { ascending:true });

  if (error) { alert(error.message); return; }

  const list = document.getElementById("commentList");
  list.innerHTML = "";
  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `<div><strong>${escapeHtml(c.users?.nickname||"Anonymous")}:</strong> ${escapeHtml(c.content)}</div>
                     <div class="meta">${new Date(c.created_at).toLocaleString()}</div>`;
    list.appendChild(div);
  });
}

checkUser();
</script>
</body>
</html>
