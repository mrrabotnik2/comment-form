<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Story Comments</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; padding:20px; }
.container { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
input, textarea, button { width:100%; padding:12px; margin-top:8px; font-size:15px; }
button { background:#4CAF50; color:white; border:none; cursor:pointer; }
button:hover { background:#45a049; }
.error { color:red; }
.success { color:green; }
.comment { border-bottom:1px solid #ddd; padding:10px 0; }
.author { font-weight:bold; }
.timestamp { font-size:12px; color:#666; }
#comment-form { display:none; margin-top:15px; }
#debug-info { font-size:12px; color:#666; background:#f0f0f0; padding:10px; margin-top:10px; border-radius:4px; }
.status-confirmed { color:green; }
.status-pending { color:orange; }
.status-not-logged-in { color:red; }
</style>
</head>
<body>

<div class="container">
<h2>Comments</h2>

<!-- DEBUG INFO -->
<div id="debug-info">
    <strong>Status:</strong> <span id="debug-status">Loading...</span><br>
    <span id="debug-details"></span>
</div>

<!-- AUTH FORM -->
<div id="auth-form">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password (min 6 chars)">
  <input id="nickname" placeholder="Choose a nickname (new users only)">
  <button id="signup-btn">Sign Up</button>
  <button id="login-btn">Log In</button>
  <button id="logout-btn" style="background:#888; display:none;">Log Out</button>
  <p id="auth-error" class="error"></p>
  <p id="auth-success" class="success"></p>
</div>

<!-- COMMENT FORM -->
<div id="comment-form">
  <p id="comment-instruction">Post your comment below:</p>
  <textarea id="comment" rows="4" placeholder="Write your comment..."></textarea>
  <button id="submit-comment-btn">Post Comment</button>
  <p id="comment-error" class="error" style="display:none;"></p>
</div>

<div id="comment-list"></div>
</div>

<script>
// =================== INITIALIZATION ===================
const SUPABASE_URL = "https://pidzgdrdgqgsayfoxqba.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpZHpnZHJkZ3Fnc2F5Zm94cWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDI1OTcsImV4cCI6MjA4MTIxODU5N30.6sNn3jbNVfl-MEowIEjUknEKHlOcfKvVRa5pFqCHiw0";

let supabase;
try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("‚úÖ Supabase initialized");
} catch (error) {
    console.error("‚ùå Supabase init error:", error);
    updateDebugInfo("error", "Failed to initialize database");
    throw error;
}

// =================== ELEMENTS ===================
const storyId = new URLSearchParams(window.location.search).get("story") || "default";
const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");
const nicknameEl = document.getElementById("nickname");
const authForm = document.getElementById("auth-form");
const commentForm = document.getElementById("comment-form");
const commentInput = document.getElementById("comment");
const commentList = document.getElementById("comment-list");
const errorEl = document.getElementById("auth-error");
const successEl = document.getElementById("auth-success");
const commentErrorEl = document.getElementById("comment-error");
const commentInstruction = document.getElementById("comment-instruction");
const debugStatus = document.getElementById("debug-status");
const debugDetails = document.getElementById("debug-details");
const logoutBtn = document.getElementById("logout-btn");

// =================== DEBUG FUNCTIONS ===================
function updateDebugInfo(status, details) {
    debugStatus.textContent = status;
    debugStatus.className = `status-${status.toLowerCase().replace(/\s+/g, '-')}`;
    debugDetails.textContent = details;
    console.log(`DEBUG: ${status} - ${details}`);
}

// =================== EVENT LISTENERS ===================
document.getElementById("signup-btn").addEventListener("click", handleSignup);
document.getElementById("login-btn").addEventListener("click", handleLogin);
document.getElementById("logout-btn").addEventListener("click", handleLogout);
document.getElementById("submit-comment-btn").addEventListener("click", handleCommentSubmit);

// =================== SIGNUP WITH DEBUG ===================
async function handleSignup() {
    errorEl.textContent = "";
    successEl.textContent = "";
    
    const email = emailEl.value.trim();
    const password = passwordEl.value;
    const nickname = nicknameEl.value.trim();
    
    if (!email || !password || !nickname) {
        errorEl.textContent = "Please fill all fields";
        return;
    }
    
    if (password.length < 6) {
        errorEl.textContent = "Password must be at least 6 characters";
        return;
    }
    
    updateDebugInfo("processing", "Creating account...");
    
    const btn = document.getElementById("signup-btn");
    btn.disabled = true;
    btn.textContent = "Signing up...";
    
    try {
        console.log("üìß Attempting signup for:", email);
        
        // IMPORTANT: Use the exact URL where users will click the confirmation link
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: { nickname: nickname },
                emailRedirectTo: window.location.origin  // This should be https://comments.mystoriesandtales.com
            }
        });
        
        console.log("üì® Signup response:", { data, error });
        
        if (error) {
            errorEl.textContent = error.message;
            updateDebugInfo("error", `Signup failed: ${error.message}`);
        } else {
            updateDebugInfo("success", "Account created! Check email for confirmation.");
            
            if (data.user) {
                // Show user details in debug
                console.log("üë§ User created:", {
                    id: data.user.id,
                    email: data.user.email,
                    confirmed: data.user.email_confirmed_at,
                    metadata: data.user.user_metadata
                });
                
                // Create profile
                try {
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .upsert({
                            id: data.user.id,
                            nickname: nickname,
                            email: email,
                            created_at: new Date().toISOString()
                        });
                    
                    if (profileError) {
                        console.log("‚ÑπÔ∏è Profile note:", profileError.message);
                    }
                } catch (profileErr) {
                    console.log("‚ÑπÔ∏è Profile creation:", profileErr.message);
                }
                
                successEl.innerHTML = `
                    ‚úÖ <strong>Sign up successful!</strong><br>
                    We've sent a confirmation email to:<br>
                    <strong>${email}</strong><br>
                    <small>Check your inbox (and spam folder) for the confirmation link.</small>
                `;
                
                localStorage.setItem('lastEmail', email);
                passwordEl.value = "";
                
                // Update UI based on confirmation status
                if (data.user.email_confirmed_at) {
                    updateDebugInfo("confirmed", "Email already confirmed!");
                    authForm.style.display = 'none';
                    commentForm.style.display = 'block';
                } else {
                    updateDebugInfo("pending", "Waiting for email confirmation...");
                }
            }
        }
    } catch (err) {
        errorEl.textContent = "Network error. Please try again.";
        updateDebugInfo("error", `Network error: ${err.message}`);
        console.error("‚ùå Signup catch error:", err);
    } finally {
        btn.disabled = false;
        btn.textContent = "Sign Up";
    }
}

// =================== LOGIN ===================
async function handleLogin() {
    errorEl.textContent = "";
    successEl.textContent = "";
    
    const email = emailEl.value.trim();
    const password = passwordEl.value;
    
    if (!email || !password) {
        errorEl.textContent = "Please enter email and password";
        return;
    }
    
    updateDebugInfo("processing", "Logging in...");
    
    const btn = document.getElementById("login-btn");
    btn.disabled = true;
    btn.textContent = "Logging in...";
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            errorEl.textContent = error.message;
            updateDebugInfo("error", `Login failed: ${error.message}`);
        } else {
            updateDebugInfo("success", `Logged in as ${email}`);
            successEl.textContent = "Login successful!";
            localStorage.setItem('lastEmail', email);
            passwordEl.value = "";
        }
    } catch (err) {
        errorEl.textContent = "Network error. Please try again.";
        updateDebugInfo("error", `Network error: ${err.message}`);
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.textContent = "Log In";
    }
}

// =================== LOGOUT ===================
async function handleLogout() {
    try {
        await supabase.auth.signOut();
        updateDebugInfo("logged-out", "Successfully logged out");
    } catch (err) {
        console.error("Logout error:", err);
    }
}

// =================== POST COMMENT ===================
async function handleCommentSubmit() {
    const content = commentInput.value.trim();
    if (!content) {
        showCommentError("Please write a comment!");
        return;
    }
    
    updateDebugInfo("processing", "Posting comment...");
    
    const btn = document.getElementById("submit-comment-btn");
    btn.disabled = true;
    btn.textContent = "Posting...";
    commentErrorEl.style.display = 'none';
    
    try {
        // 1. Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError) {
            showCommentError("Session error. Please log in again.");
            updateDebugInfo("error", "Session expired");
            authForm.style.display = 'block';
            commentForm.style.display = 'none';
            return;
        }
        
        if (!user) {
            showCommentError("Please log in to comment.");
            updateDebugInfo("not-logged-in", "No user session");
            authForm.style.display = 'block';
            commentForm.style.display = 'none';
            return;
        }
        
        console.log("üë§ Current user check:", {
            email: user.email,
            confirmed: user.email_confirmed_at,
            confirmedAt: user.email_confirmed_at,
            id: user.id
        });
        
        // 2. Check email confirmation
        if (!user.email_confirmed_at) {
            const msg = `Please confirm your email first. Check ${user.email} for the confirmation link.`;
            showCommentError(msg);
            updateDebugInfo("pending", `Email not confirmed for ${user.email}`);
            return;
        }
        
        // 3. Post the comment
        updateDebugInfo("processing", `Posting to story: ${storyId}`);
        
        const { error: insertError } = await supabase
            .from("story_comments")
            .insert({
                story_id: storyId,
                user_id: user.id,
                content: content,
                created_at: new Date().toISOString()
            });
        
        if (insertError) {
            showCommentError("Failed to post: " + insertError.message);
            updateDebugInfo("error", `Post failed: ${insertError.message}`);
            console.error("‚ùå Insert error:", insertError);
        } else {
            // Success!
            commentInput.value = "";
            loadComments();
            
            updateDebugInfo("success", "Comment posted!");
            commentErrorEl.style.display = 'block';
            commentErrorEl.className = 'success';
            commentErrorEl.innerHTML = "‚úÖ Comment posted successfully!";
            setTimeout(() => {
                commentErrorEl.style.display = 'none';
            }, 3000);
        }
    } catch (err) {
        showCommentError("Error: " + err.message);
        updateDebugInfo("error", `Exception: ${err.message}`);
        console.error("‚ùå Post error:", err);
    } finally {
        btn.disabled = false;
        btn.textContent = "Post Comment";
    }
}

function showCommentError(message) {
    commentErrorEl.innerHTML = message;
    commentErrorEl.style.display = 'block';
    commentErrorEl.className = 'error';
}

// =================== LOAD COMMENTS ===================
async function loadComments() {
    try {
        updateDebugInfo("loading", "Fetching comments...");
        
        const { data, error } = await supabase
            .from("story_comments")
            .select(`
                content, 
                created_at,
                profiles (nickname)
            `)
            .eq("story_id", storyId)
            .order("created_at", { ascending: false });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            commentList.innerHTML = "<p>No comments yet. Be the first!</p>";
            updateDebugInfo("loaded", "No comments found");
        } else {
            commentList.innerHTML = data.map(comment => `
                <div class="comment">
                    <div class="author">${comment.profiles?.nickname || 'Anonymous'}</div>
                    <div>${comment.content}</div>
                    <div class="timestamp">${new Date(comment.created_at).toLocaleString()}</div>
                </div>
            `).join('');
            updateDebugInfo("loaded", `${data.length} comments loaded`);
        }
    } catch (err) {
        console.error("‚ùå Load comments error:", err);
        commentList.innerHTML = `<p class="error">Error loading comments</p>`;
        updateDebugInfo("error", `Failed to load: ${err.message}`);
    }
}

// =================== AUTH STATE ===================
supabase.auth.onAuthStateChange(async (event, session) => {
    console.log("üîê Auth event:", event, session?.user?.email);
    
    if (event === "SIGNED_IN" && session?.user) {
        console.log("üìã User details:", {
            email: session.user.email,
            confirmed: session.user.email_confirmed_at,
            confirmedAt: session.user.email_confirmed_at,
            metadata: session.user.user_metadata
        });
        
        // Show logout button
        logoutBtn.style.display = 'inline-block';
        
        // Show appropriate message
        if (session.user.email_confirmed_at) {
            authForm.style.display = "none";
            commentForm.style.display = "block";
            commentInstruction.textContent = `Posting as: ${session.user.user_metadata?.nickname || session.user.email}`;
            updateDebugInfo("confirmed", `Ready to comment as ${session.user.email}`);
        } else {
            authForm.style.display = "block";
            commentForm.style.display = "none";
            updateDebugInfo("pending", `Email not confirmed: ${session.user.email}`);
            successEl.innerHTML = `
                ‚ö†Ô∏è <strong>Email not confirmed</strong><br>
                Check <strong>${session.user.email}</strong> for the confirmation link.<br>
                <small>Check spam folder if you don't see it.</small>
            `;
        }
    } else if (event === "SIGNED_OUT") {
        authForm.style.display = "block";
        commentForm.style.display = "none";
        logoutBtn.style.display = 'none';
        successEl.textContent = "";
        updateDebugInfo("not-logged-in", "Please sign in to comment");
    } else if (event === "USER_UPDATED") {
        // When user confirms email
        if (session?.user?.email_confirmed_at) {
            authForm.style.display = "none";
            commentForm.style.display = "block";
            commentInstruction.textContent = `Posting as: ${session.user.user_metadata?.nickname || session.user.email}`;
            updateDebugInfo("confirmed", `‚úÖ Email confirmed! Ready to comment.`);
            successEl.textContent = "‚úÖ Email confirmed! You can now post comments.";
        }
    }
    
    loadComments();
});

// =================== INITIAL LOAD ===================
async function initApp() {
    try {
        // Restore last email
        const lastEmail = localStorage.getItem('lastEmail');
        if (lastEmail && emailEl && !emailEl.value) {
            emailEl.value = lastEmail;
        }
        
        // Check existing session
        const { data: { session } } = await supabase.auth.getSession();
        console.log("üîç Initial session check:", session?.user?.email);
        
        if (session?.user) {
            updateDebugInfo("checking", `Found session for ${session.user.email}`);
            
            if (session.user.email_confirmed_at) {
                authForm.style.display = "none";
                commentForm.style.display = "block";
                commentInstruction.textContent = `Posting as: ${session.user.user_metadata?.nickname || session.user.email}`;
                logoutBtn.style.display = 'inline-block';
                updateDebugInfo("confirmed", `Ready: ${session.user.email}`);
            } else {
                updateDebugInfo("pending", `Email not confirmed: ${session.user.email}`);
                successEl.innerHTML = `Please confirm ${session.user.email}`;
            }
        } else {
            updateDebugInfo("not-logged-in", "Please sign in or create account");
        }
        
        // Load comments
        await loadComments();
        
    } catch (err) {
        console.error("‚ùå Init error:", err);
        updateDebugInfo("error", `Init failed: ${err.message}`);
    }
}

// Start the app
initApp();
</script>

</body>
</html>
