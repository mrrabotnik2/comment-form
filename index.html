<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Auth + Comments</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f9;
  display: flex;
  justify-content: center;
  padding: 30px;
}
.container {
  max-width: 600px;
  width: 100%;
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
input, textarea, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
}
button {
  background: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover { background: #45a049; }
.error { color: red; }
.success { color: green; }
.comment { border-bottom: 1px solid #ddd; padding: 10px 0; }
.author { font-weight: bold; }
#comment-form { display: none; }
</style>
</head>

<body>
<div class="container">

<h2>Sign Up / Log In</h2>

<div id="auth-form">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">

  <button id="signup-btn" type="button">Sign Up</button>
  <button id="login-btn" type="button">Log In</button>

  <p id="auth-error" class="error"></p>
  <p id="auth-success" class="success"></p>
</div>

<div id="comment-form">
  <h3>Leave a comment</h3>
  <textarea id="comment" rows="4"></textarea>
  <button id="submit-comment-btn" type="button">Submit Comment</button>
</div>

<h3>Comments</h3>
<div id="comment-list"></div>

</div>

<script>
/* âœ… CORRECT SUPABASE INIT */
const supabase = window.supabase.createClient(
  "https://pidzgdrdgqgsayfoxqba.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpZHpnZHJkZ3Fnc2F5Zm94cWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDI1OTcsImV4cCI6MjA4MTIxODU5N30.6sNn3jbNVfl-MEowIEjUknEKHlOcfKvVRa5pFqCHiw0"
);

const email = document.getElementById("email");
const password = document.getElementById("password");
const errorEl = document.getElementById("auth-error");
const successEl = document.getElementById("auth-success");
const authForm = document.getElementById("auth-form");
const commentForm = document.getElementById("comment-form");
const commentInput = document.getElementById("comment");
const commentList = document.getElementById("comment-list");

document.getElementById("signup-btn").onclick = async () => {
  errorEl.textContent = "";
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: password.value,
    options: { emailRedirectTo: window.location.href }
  });
  if (error) errorEl.textContent = error.message;
  else successEl.textContent = "Check your email to confirm your account.";
};

document.getElementById("login-btn").onclick = async () => {
  errorEl.textContent = "";
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) errorEl.textContent = error.message;
};

document.getElementById("submit-comment-btn").onclick = async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("Login required");

  await supabase.from("story_comments").insert({
    content: commentInput.value,
    user_id: user.id,
    story_id: "test"
  });

  commentInput.value = "";
  loadComments();
};

async function loadComments() {
  const { data } = await supabase
    .from("story_comments")
    .select("content, created_at")
    .order("created_at", { ascending: false });

  commentList.innerHTML = (data || []).map(c => `
    <div class="comment">
      <div class="author">Anonymous</div>
      <div>${c.content}</div>
      <div style="font-size:12px;color:#666">
        ${new Date(c.created_at).toLocaleString()}
      </div>
    </div>
  `).join("");
}

supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    authForm.style.display = "none";
    commentForm.style.display = "block";
  } else {
    authForm.style.display = "block";
    commentForm.style.display = "none";
  }
  loadComments();
});

loadComments();
</script>
</body>
</html>
