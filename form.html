<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forum</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2em auto; }
    h3, h4 { margin-bottom: 0.5em; }
    select, textarea, button { display: block; width: 100%; margin-bottom: 1em; padding: 0.5em; }
    textarea { resize: vertical; height: 80px; }
    .thread, .post { border-bottom: 1px dotted #333; padding: 0.5em 0; }
    .thread:hover { background: #f4f4f4; cursor: pointer; }
    .hidden { display: none; }

    /* Compact login form */
    #auth-section input[type="email"] {
      width: 250px;       /* ~30-35 characters */
      padding: 0.4em;
      font-size: 1em;
      display: inline-block;
      margin-right: 0.5em;
    }
    #auth-section button {
      padding: 0.45em 1em; /* Slightly bigger than text */
      font-size: 1em;
      display: inline-block;
      vertical-align: middle;
    }
    #auth-msg {
      margin-top: 0.5em;
      font-size: 0.9em;
      color: green;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h3>Forum</h3>

<div id="auth-section">
  <input id="email" type="email" placeholder="Enter your email">
  <button onclick="sendMagicLink()">Send Magic Link</button>
  <p id="auth-msg"></p>
</div>

<div id="forum-section" class="hidden">
  <p>Logged in as: <span id="user-email"></span></p>

  <h4>Sections</h4>
  <select id="section-select" onchange="loadThreads()"></select>

  <h4>Threads</h4>
  <div id="threads"></div>

  <h4>Posts</h4>
  <div id="posts"></div>

  <h4>New Post</h4>
  <textarea id="new-post-content" placeholder="Write your post..."></textarea>
  <button onclick="postNew()">Post</button>
</div>

<script>
// -------------------
// Supabase Initialization
// -------------------
const SUPABASE_URL = 'https://pidzgdrdgqgsayfoxqba.supabase.co';
const SUPABASE_KEY = 'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentSectionId = null;
let currentThreadId = null;

// -------------------
// Magic Link
// -------------------
async function sendMagicLink() {
  const email = document.getElementById('email').value.trim();
  if (!email) { alert('Enter your email'); return; }

  const { error } = await sb.auth.signInWithOtp({
    email, 
    options: { emailRedirectTo: window.location.href }
  });

  if (error) {
    document.getElementById('auth-msg').innerText = 'Error sending Magic Link: ' + error.message;
  } else {
    document.getElementById('auth-msg').innerText = 'Magic Link sent! Check your email.';
  }
}

// -------------------
// Check user login on page load
// -------------------
async function checkUser() {
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) {
    currentUser = session.user;
    document.getElementById('user-email').innerText = currentUser.email;
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('forum-section').classList.remove('hidden');
    loadSections();
  }
}
checkUser();

// -------------------
// Load Sections
// -------------------
async function loadSections() {
  const { data, error } = await sb.from('forum_sections').select('*').order('created_at', { ascending: true });
  if (error) { console.error(error); return; }

  const select = document.getElementById('section-select');
  select.innerHTML = '';
  data.forEach(section => {
    const option = document.createElement('option');
    option.value = section.id;
    option.textContent = section.title;
    select.appendChild(option);
  });
  if (data.length > 0) {
    currentSectionId = data[0].id;
    loadThreads();
  }
}

// -------------------
// Load Threads
// -------------------
async function loadThreads() {
  currentSectionId = parseInt(document.getElementById('section-select').value);
  const { data, error } = await sb
    .from('threads')
    .select('*')
    .eq('section_id', currentSectionId)
    .order('created_at', { ascending: true });
  if (error) { console.error(error); return; }

  const container = document.getElementById('threads');
  container.innerHTML = '';
  data.forEach(thread => {
    const div = document.createElement('div');
    div.className = 'thread';
    div.textContent = thread.title;
    div.onclick = () => { currentThreadId = thread.id; loadPosts(); };
    container.appendChild(div);
  });

  document.getElementById('posts').innerHTML = '';
}

// -------------------
// Load Posts
// -------------------
async function loadPosts() {
  if (!currentThreadId) return;
  const { data: posts, error } = await sb
    .from('posts')
    .select('id, content, author_id, created_at')
    .eq('thread_id', currentThreadId)
    .order('created_at', { ascending: true });
  if (error) { console.error(error); return; }

  const container = document.getElementById('posts');
  container.innerHTML = '';

  for (const post of posts) {
    // Fetch author email
    const { data: userData } = await sb.auth.admin.getUserById(post.author_id);
    const authorEmail = userData?.email || 'Anonymous';

    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<strong>${authorEmail}</strong><br>${post.content}`;
    container.appendChild(div);
  }
}

// -------------------
// Post New Post
// -------------------
async function postNew() {
  const content = document.getElementById('new-post-content').value.trim();
  if (!content) { alert('Enter a message'); return; }
  if (!currentThreadId) { alert('Select a thread'); return; }

  const { error } = await sb.from('posts').insert({
    thread_id: currentThreadId,
    content: content,
    author_id: currentUser.id,
    created_at: new Date()
  });

  if (error) { alert('Error posting: ' + error.message); return; }

  document.getElementById('new-post-content').value = '';
  loadPosts();
}
</script>
</body>
</html>
