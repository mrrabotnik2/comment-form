<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forum</title>

  <style>
    body { font-family: serif; max-width: 700px; margin: 2em auto; }
    input, textarea, button, select { margin-bottom: 1em; font-size: 1em; }
    textarea { width: 100%; height: 80px; resize: vertical; }
    button { cursor: pointer; }
    .section, .thread, .post { padding: 0.5em; border-bottom: 1px dotted #000; }
    .thread { margin-left: 1em; }
    .post { margin-left: 2em; }
    #forumDiv { display: none; }
    #userEmail { font-weight: bold; margin-bottom: 1em; display: none; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>Forum</h2>

<!-- Login -->
<div id="loginDiv">
  <input id="email" type="email" placeholder="Your Email">
  <button onclick="sendMagicLink()">Send Magic Link</button>
</div>

<div id="userEmail"></div>

<!-- Forum -->
<div id="forumDiv">
  <h4>Sections</h4>
  <select id="sections" onchange="loadThreads()"></select>
  <button onclick="createThreadPrompt()">New Thread</button>

  <h4>Threads</h4>
  <div id="threads"></div>

  <h4>Posts</h4>
  <div id="posts"></div>
  <textarea id="postContent" placeholder="Write a reply..."></textarea><br>
  <button onclick="postReply()">Post Reply</button>
</div>

<script>
  // Initialize Supabase
  const sb = supabase.createClient(
    'https://pidzgdrdgqgsayfoxqba.supabase.co',
    'sb_publishable_-rGnPqFMdXSVXmKdI2bCow_R7uuC53z'
  );

  let currentUser = null;
  let currentSection = null;
  let currentThread = null;

  // ================================
  // Magic Link login
  // ================================
  async function sendMagicLink() {
    const email = document.getElementById('email').value.trim();
    if (!email) { alert('Enter your email'); return; }

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: 'https://mrrabotnik2.github.io/comment-form/form.html'
      }
    });

    if (error) { console.error(error); alert('Error sending Magic Link: ' + error.message); return; }
    alert('Check your email for the Magic Link!');
  }

  async function checkUser() {
    const { data: { session } } = await sb.auth.getSession();
    currentUser = session?.user ?? null;

    if (currentUser) {
      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('userEmail').style.display = 'block';
      document.getElementById('userEmail').innerText = 'Logged in as: ' + currentUser.email;
      document.getElementById('forumDiv').style.display = 'block';
      loadSections();
    }
  }

  sb.auth.onAuthStateChange((_event, session) => { currentUser = session?.user ?? null; checkUser(); });
  checkUser();

  // ================================
  // Load sections
  // ================================
  async function loadSections() {
    const { data, error } = await sb.from('forum_sections').select('*');
    if (error) { console.error(error); return; }

    const sel = document.getElementById('sections');
    sel.innerHTML = '';
    data.forEach(sec => sel.add(new Option(sec.name, sec.id)));
    if (data.length > 0) { currentSection = data[0].id; loadThreads(); }
  }

  // ================================
  // Load threads
  // ================================
  async function loadThreads() {
    const sel = document.getElementById('sections');
    currentSection = sel.value;
    const { data, error } = await sb.from('threads').select('*').eq('section_id', currentSection).order('created_at', { ascending: false });
    if (error) { console.error(error); return; }

    const container = document.getElementById('threads');
    container.innerHTML = '';
    data.forEach(t => {
      const div = document.createElement('div');
      div.className = 'thread';
      div.innerHTML = `<strong>${t.title}</strong> <button onclick="loadPosts('${t.id}')">Open</button>`;
      container.appendChild(div);
    });
  }

  // ================================
  // Load posts
  // ================================
  async function loadPosts(threadId) {
    currentThread = threadId;
    const { data, error } = await sb.from('posts').select('*').eq('thread_id', threadId).order('created_at', { ascending: true });
    if (error) { console.error(error); return; }

    const container = document.getElementById('posts');
    container.innerHTML = '';
    data.forEach(p => {
      const div = document.createElement('div');
      div.className = 'post';
      div.innerHTML = `<strong>${p.author_id}</strong><br>${p.content}`;
      container.appendChild(div);
    });
  }

  // ================================
  // Post reply
  // ================================
  async function postReply() {
    if (!currentThread) { alert('Select a thread first'); return; }
    const content = document.getElementById('postContent').value.trim();
    if (!content) { alert('Enter your reply'); return; }

    const { error } = await sb.from('posts').insert({
      thread_id: currentThread,
      content,
      author_id: currentUser.email
    });

    if (error) { console.error(error); alert('Error posting reply'); return; }
    document.getElementById('postContent').value = '';
    loadPosts(currentThread);
  }

  // ================================
  // Create new thread
  // ================================
  function createThreadPrompt() {
    const title = prompt('Enter thread title');
    if (!title) return;
    createThread(title);
  }

  async function createThread(title) {
    const { data, error } = await sb.from('threads').insert({
      section_id: currentSection,
      title,
      author_id: currentUser.email
    });
    if (error) { console.error(error); alert('Error creating thread'); return; }
    loadThreads();
  }
</script>
</body>
</html>
